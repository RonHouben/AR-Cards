<!DOCTYPE html>
<html lang='en'>

    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <meta http-equiv='X-UA-Compatible' content='ie=edge'>
        <link rel='stylesheet' href='styles/style.css'>
        <title>AR-Cards test</title>
    </head>

    <body>
        <!-- include three.js library -->
        <script type='text/javascript' src='js/three.js'></script>
        <script type='text/javascript' src='js/GLTFLoader.js'></script>
        <!-- include jsartookit -->
        <script src="jsartoolkit5/artoolkit.min.js"></script>
        <script src="jsartoolkit5/artoolkit.api.js"></script>
        <!-- include threex.artoolkit -->
        <script src="threex/threex-artoolkitsource.js"></script>
        <script src="threex/threex-artoolkitcontext.js"></script>
        <script src="threex/threex-arbasecontrols.js"></script>
        <script src="threex/threex-armarkercontrols.js"></script>

        <script>
            var WINDOW_WIDTH = window.innerWidth
            var WINDOW_HEIGHT = window.innerHeight

            var scene, camera, renderer, clock, deltaTime, totalTime
            var arToolkitSource, arToolkitContext
            var markerRoot1
            var material1, mesh1
            var light

            initialize()
            animate()

            function initialize() {
                scene = new THREE.Scene()

                camera = new THREE.Camera()
                scene.add(camera)

                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true
                })
                renderer.setClearColor(new THREE.Color('lightgrey'), 0)
                renderer.setSize(WINDOW_WIDTH, WINDOW_HEIGHT)
                document.body.appendChild(renderer.domElement)

                clock = new THREE.Clock()
                deltaTime = 0
                totalTime = 0

                ////////////////////////////////////////////////////////////
                // setup arToolkitSource
                ////////////////////////////////////////////////////////////
                arToolkitSource = new THREEx.ArToolkitSource({
                    sourceType: 'webcam',
                })

                function onResize() {
                    arToolkitSource.onResizeElement()
                    arToolkitSource.copyElementSizeTo(renderer.domElement)
                    if (arToolkitContext.arController !== null) {
                        arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
                    }
                }
                // initiate webcam
                arToolkitSource.init(function onReady() {
                    onResize()
                })

                // handle resize event
                window.addEventListener('resize', function() {
                    onResize()
                })

                ////////////////////////////////////////////////////////////
                // setup arToolkitContext
                ////////////////////////////////////////////////////////////
                // create atToolkitContext
                arToolkitContext = new THREEx.ArToolkitContext({
                    cameraParametersUrl: 'data/camera_para.dat',
                    detectionMode: 'mono'
                })

                // copy projection matrix to camera when initialization complete
                arToolkitContext.init(function onCompleted() {
                    camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                });

                ////////////////////////////////////////////////////////////
                // setup markerRoots
                ////////////////////////////////////////////////////////////
                // build markerControls
                markerRoot1 = new THREE.Group()
                scene.add(markerRoot1)
                let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
                    type: 'pattern', patternUrl: "data/hiro.patt",
                })

                ////////////////////////////////////////////////////////////
                // setup scene
                ////////////////////////////////////////////////////////////
                renderer.shadowMap.enabled = true
                renderer.shadowMap.type = THREE.PCFSoftShadowMap

                var loader = new THREE.GLTFLoader()

                let sceneGroup = new THREE.Group()
                markerRoot1.add(sceneGroup)

                // add floor for shadows
                let floorGeometry = new THREE.PlaneGeometry(20, 20)
                let floorMaterial = new THREE.ShadowMaterial()
                floorMaterial.opacity = 0.3
                let floorMesh = new THREE.Mesh(floorGeometry, floorMaterial)
                floorMesh.rotation.x = -Math.PI / 2
                floorMesh.receiveShadow = true
                sceneGroup.add(floorMesh)

                function onProgress(xhr) { console.log((xhr.loaded / xhr.total * 100) + '% loaded') }
                function onError(xhr) { console.log('An error happened') }

                // Load a glTF resource
                loader.load(
                    '/models/accenture-ar.gltf',
                    function(group) {
                        logo = group.scene
                        logo.scale.set(0.2, 0.2, 0.2)
                        logo.castShadow = true
                        sceneGroup.add(logo)
                    },
                    onProgress,
                    onError
                )

                // create lighting
                light = new THREE.PointLight(0xFFFFFF, 1, 100)
                light.position.set(0, 4, 0)
                light.castShadow = true
                sceneGroup.add(light)

                let lightSphere = new THREE.Mesh(
                    new THREE.SphereGeometry(0.1),
                    new THREE.MeshBasicMaterial({
                        color: 0xffffff,
                        transparent: true,
                        opacity: 0.8
                    })
                );
                lightSphere.position.copy(light.position)
                sceneGroup.add(lightSphere)

                let ambientLight = new THREE.AmbientLight(0x6F6666, 2);
                sceneGroup.add(ambientLight)
            }

            // let helper = new THREE.CameraHelper(light.shadow.camera);
            // sceneGroup.add(helper)

            // game logic
            function update() {
                // console.log(camera.position)
                light.position.set(camera.position.x, camera.position.y, camera.position.z + 1)
                if (arToolkitSource.ready !== false)
                    arToolkitContext.update(arToolkitSource.domElement)
            }

            // draw scene
            function render() {
                renderer.render(scene, camera)
            }

            // run game loop (update, render, repeat)
            function animate() {
                requestAnimationFrame(animate)
                deltaTime = clock.getDelta()
                totalTime += deltaTime
                update()
                render()
            }
        </script>
    </body>

</html>